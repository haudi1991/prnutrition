<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Protocol suplimente</title>

  <style>
    :root{
      --bg:#0b0f17;
      --muted:#9fb0c3;
      --text:#eaf1ff;
      --accent:#7dd3fc;
      --line:rgba(255,255,255,.10);
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius: 18px;
      --panel: rgba(255,255,255,.03);
    }
    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(125,211,252,.15), transparent 60%),
        radial-gradient(900px 700px at 80% 20%, rgba(167,243,208,.12), transparent 55%),
        var(--bg);
      color:var(--text);
      line-height:1.55;
      padding: 22px 14px;
    }
    .wrap{ max-width: 980px; margin: 0 auto; }

    header{
      display:flex; flex-direction:column; gap:10px;
      margin-bottom:14px;
    }
    .badge{
      display:inline-flex; align-items:center;
      font-size: 12px; color: var(--muted);
      padding: 7px 10px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background: rgba(255,255,255,.03);
      width: fit-content;
    }
    h1{
      font-size: clamp(24px, 2.8vw, 34px);
      margin:0;
      letter-spacing: -0.02em;
    }
    .sub{
      margin:0;
      color: var(--muted);
      max-width: 90ch;
      font-size: 13px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .section{ padding: 16px; }

    .panel{
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      background: var(--panel);
      padding: 14px;
    }

    /* ===== Print-only title ===== */
    .print-title{
      display:none;
      font-weight: 900;
      letter-spacing: -0.01em;
      margin: 0 0 10px 0;
    }
    .print-title .muted{ color: rgba(234,241,255,.80); }

    /* ===== Editor UI ===== */
    .editor{ display:grid; gap: 10px; }

    .grid2{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media (min-width: 820px){
      .grid2{ grid-template-columns: 1fr 1fr; }
    }

    .field{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .field label{
      display:block;
      font-size: 12px;
      color: rgba(234,241,255,.70);
      margin-bottom: 6px;
    }
    .field input, .field textarea, .field select{
      width:100%;
      font: inherit;
      color: var(--text);
      background: rgba(255,255,255,.02);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 12px;
      padding: 10px 10px;
      outline: none;
    }
    .field textarea{ min-height: 130px; resize: vertical; }

    .btnrow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-top: 8px;
    }
    .btn{
      cursor:pointer;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding: 9px 12px;
      border-radius: 12px;
      font: inherit;
      font-size: 13px;
      white-space: nowrap;
    }
    .btn:hover{ background: rgba(255,255,255,.06); }

    .hint{
      font-size: 12px;
      color: rgba(234,241,255,.62);
      line-height: 1.4;
    }

    .callout{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(125,211,252,.06);
      color: rgba(234,241,255,.80);
      font-size: 13px;
      line-height: 1.4;
    }

    /* ===== Catalog ===== */
    .catalog-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top: 8px;
    }
    @media (min-width: 820px){
      .catalog-grid{ grid-template-columns: 1fr 1fr; }
    }
    .item{
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      background: rgba(255,255,255,.02);
      padding: 10px 12px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .item .name{
      font-weight: 850;
      color: rgba(234,241,255,.92);
      letter-spacing: -0.01em;
    }
    .item .meta{
      font-size: 12px;
      color: rgba(234,241,255,.70);
      line-height: 1.35;
      word-break: break-word;
    }
    .item .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top: 6px;
    }

    /* ===== Table ===== */
    .table-wrap{
      margin-top: 12px;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      overflow:hidden;
      background: rgba(255,255,255,.02);
    }
    table{
      width:100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    thead th{
      text-align:left;
      font-weight: 850;
      color: rgba(234,241,255,.90);
      background: rgba(255,255,255,.04);
      border-bottom: 1px solid rgba(255,255,255,.10);
      padding: 10px 10px;
      vertical-align: top;
    }
    tbody td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      color: rgba(234,241,255,.78);
      vertical-align: top;
      word-break: break-word;
    }
    tbody tr:last-child td{ border-bottom: none; }

    /* =========================
       PRINT (PDF)
       ========================= */
    @media print {
      *{
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      @page{
        size: A4 landscape;
        margin: 6mm;
      }
      html, body{
        background: var(--bg) !important;
        color: var(--text) !important;
        margin: 0 !important;
        padding: 0 !important;
      }

      header{ display:none !important; }
      .editor, .btnrow, .hint, .catalog-area, .protocol-area, .std-protocol-area, .backup-area { display:none !important; }

      .section{ padding: 12px !important; }
      .panel{ padding: 10px !important; }

      .print-title{
        display:block !important;
        font-size: 20px !important;
      }

      table{ font-size: 12px !important; }
      thead th, tbody td{ padding: 8px 8px !important; }

      .table-wrap, .panel, .callout{
        break-inside: avoid !important;
        page-break-inside: avoid !important;
      }

      a[href]::after{ content: "" !important; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="badge">üíä Protocol suplimente</div>
      <h1>Protocol suplimente ‚Äì <span id="clientNameOut">Client</span></h1>
      <p class="sub">
        Standard: catalog + protocoale din GitHub. Per-client: salvat local (Save/Load + Export/Import). La print rƒÉm√¢ne doar titlul + obiectiv + tabelul.
      </p>
    </header>

    <main class="card">
      <section class="section">
        <div class="panel">

          <!-- Titlu pentru PDF (print only) -->
          <div class="print-title">
            Protocol suplimente ‚Äì <span id="printName" class="muted">Client</span>
          </div>

          <div class="editor">

            <div class="grid2">
              <div class="field">
                <label>Nume client</label>
                <input id="clientName" placeholder="Ex: Andrei Popescu" />
              </div>
              <div class="field">
                <label>Obiectiv / context (1‚Äì2 fraze)</label>
                <input id="goal" placeholder="Ex: somn, energie, stres, recuperare..." />
              </div>
            </div>

            <!-- Protocoale standard (GitHub) -->
            <div class="std-protocol-area field">
              <label>Protocoale standard (GitHub)</label>

              <div class="grid2">
                <div>
                  <select id="stdProtocolSelect"></select>
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <button class="btn" id="reloadStdProtocols" type="button">Re√ÆncarcƒÉ</button>
                  <button class="btn" id="addStdProtocol" type="button">AdaugƒÉ protocol</button>
                </div>
              </div>

              <div class="hint" style="margin-top:8px;">
                ‚ÄúAdaugƒÉ protocol‚Äù √Æl pune peste ce ai deja √Æn listƒÉ (textarea).
              </div>
            </div>

            <!-- Protocoluri salvate (local) -->
            <div class="protocol-area field">
              <label>Protocoluri salvate (local)</label>
              <div class="grid2">
                <div><select id="protocolSelect"></select></div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <button class="btn" id="saveProtocol" type="button">Save</button>
                  <button class="btn" id="loadProtocol" type="button">Load</button>
                  <button class="btn" id="deleteProtocol" type="button">Delete</button>
                </div>
              </div>

              <div class="grid2" style="margin-top:10px;">
                <div><input id="protocolName" placeholder="Nume protocol (ex: Somn ‚Äì client X)" /></div>
                <div class="hint">SalveazƒÉ nume + obiectiv + lista de suplimente √Æn browser (local).</div>
              </div>
            </div>

            <!-- Backup (Export/Import) -->
            <div class="backup-area field">
              <label>Backup (Export/Import) ‚Äì local</label>
              <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                <button class="btn" id="exportAll" type="button">Export backup.json</button>
                <button class="btn" id="importAllBtn" type="button">Import backup.json</button>
                <input id="importFile" type="file" accept="application/json" style="display:none;" />
              </div>
              <div class="hint" style="margin-top:8px;">
                Backup-ul con»õine: protocoale locale + ultima stare + suplimente adƒÉugate local (nu modificƒÉ fi»ôierele din GitHub).
              </div>
            </div>

            <!-- Catalog standard + local additions -->
            <div class="catalog-area field">
              <label>Catalog suplimente (standard + local)</label>
              <div class="grid2">
                <div><input id="catalogSearch" placeholder="CautƒÉ (ex: vitamina d, omega, magneziu)" /></div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <button class="btn" id="reloadCatalog" type="button">Re√ÆncarcƒÉ catalog</button>
                  <button class="btn" id="resetLocalCatalog" type="button">Reset local additions</button>
                </div>
              </div>

              <div class="catalog-grid" id="catalogList"></div>

              <div class="hint" style="margin-top:10px;">
                DacƒÉ vrei ‚Äúdefault personal‚Äù (doar pentru browserul tƒÉu), adaugƒÉ aici:
              </div>

              <div class="grid2" style="margin-top:8px;">
                <div class="field" style="margin:0;">
                  <label>Supliment</label>
                  <input id="newName" placeholder="Ex: CreatinƒÉ monohidrat" />
                </div>
                <div class="field" style="margin:0;">
                  <label>DozƒÉ</label>
                  <input id="newDose" placeholder="Ex: 3‚Äì5 g" />
                </div>
              </div>

              <div class="grid2">
                <div class="field" style="margin:0;">
                  <label>C√¢nd/Cum</label>
                  <input id="newWhenHow" placeholder="Ex: zilnic, cu apƒÉ / cu masƒÉ" />
                </div>
                <div class="field" style="margin:0;">
                  <label>Link</label>
                  <input id="newLink" placeholder="https://..." />
                </div>
              </div>

              <div class="field" style="margin:0;">
                <label>Note</label>
                <input id="newNotes" placeholder="Ex: energie / performan»õƒÉ" />
              </div>

              <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:8px;">
                <button class="btn" id="addToLocalCatalog" type="button">AdaugƒÉ (local)</button>
              </div>
            </div>

            <!-- Input principal (editare ca p√¢nƒÉ acum) -->
            <div class="field">
              <label>Suplimente (c√¢te un r√¢nd). Format: Supliment | DozƒÉ | C√¢nd/Cum | Link | Note</label>
              <textarea id="suppInput" spellcheck="false"
                placeholder="Ex:
Vitamina D3 | 2000 UI | diminea»õa, cu masƒÉ cu grƒÉsimi | https://... | iarna
Omega-3 | 1‚Äì2 g EPA+DHA | pr√¢nz/cinƒÉ, cu m√¢ncare | https://... | recuperare
Magneziu (glicinat) | 200‚Äì400 mg | seara, cu apƒÉ | https://... | somn

# Liniile care √Æncep cu # sunt ignorate."></textarea>

              <div class="btnrow">
                <button class="btn" id="clearAll" type="button">»òterge tot</button>
                <div class="hint">R√¢nduri √Æn tabel: <b id="rowCount">0</b></div>
              </div>
            </div>

          </div>

          <div class="callout">
            <b>Obiectiv:</b> <span id="goalOut">‚Äî</span>
          </div>

          <div class="table-wrap" aria-label="Tabel suplimente">
            <table>
              <thead>
                <tr>
                  <th style="width:22%;">Supliment</th>
                  <th style="width:12%;">DozƒÉ</th>
                  <th style="width:22%;">C√¢nd/Cum</th>
                  <th style="width:22%;">Link</th>
                  <th>Note</th>
                </tr>
              </thead>
              <tbody id="suppTbody"></tbody>
            </table>
          </div>

        </div>
      </section>
    </main>
  </div>

  <script>
    const els = {
      clientName: document.getElementById('clientName'),
      goal: document.getElementById('goal'),
      suppInput: document.getElementById('suppInput'),
      clientNameOut: document.getElementById('clientNameOut'),
      printName: document.getElementById('printName'),
      goalOut: document.getElementById('goalOut'),
      tbody: document.getElementById('suppTbody'),
      rowCount: document.getElementById('rowCount'),

      // std protocols (GitHub)
      stdProtocolSelect: document.getElementById('stdProtocolSelect'),
      reloadStdProtocols: document.getElementById('reloadStdProtocols'),
      addStdProtocol: document.getElementById('addStdProtocol'),

      // local protocols
      protocolSelect: document.getElementById('protocolSelect'),
      protocolName: document.getElementById('protocolName'),
      saveProtocol: document.getElementById('saveProtocol'),
      loadProtocol: document.getElementById('loadProtocol'),
      deleteProtocol: document.getElementById('deleteProtocol'),

      // backup
      exportAll: document.getElementById('exportAll'),
      importAllBtn: document.getElementById('importAllBtn'),
      importFile: document.getElementById('importFile'),

      // catalog
      catalogSearch: document.getElementById('catalogSearch'),
      catalogList: document.getElementById('catalogList'),
      reloadCatalog: document.getElementById('reloadCatalog'),
      resetLocalCatalog: document.getElementById('resetLocalCatalog'),

      newName: document.getElementById('newName'),
      newDose: document.getElementById('newDose'),
      newWhenHow: document.getElementById('newWhenHow'),
      newLink: document.getElementById('newLink'),
      newNotes: document.getElementById('newNotes'),
      addToLocalCatalog: document.getElementById('addToLocalCatalog'),

      clearAll: document.getElementById('clearAll'),
    };

    const STORAGE_STATE = 'supp_state_v6';
    const STORAGE_PROTOCOLS = 'supp_protocols_v3';
    const STORAGE_LOCAL_CATALOG = 'supp_catalog_local_v2';

    // caches
    let remoteCatalogCache = [];
    let mergedCatalogCache = [];

    let stdProtocolsCache = [];

    function safeTrim(x){ return (x ?? '').toString().trim(); }

    // ===== Remote catalog from GitHub Pages =====
    async function loadRemoteCatalog(){
      try{
        const res = await fetch('../../data/catalog.json', { cache: 'no-store' });
        if (!res.ok) return [];
        const data = await res.json();
        return Array.isArray(data) ? data : [];
      }catch(e){
        return [];
      }
    }

    // ===== Standard protocols from GitHub Pages =====
    async function loadStdProtocols(){
      try{
        const res = await fetch('../../data/protocols.json', { cache: 'no-store' });
        if (!res.ok) return [];
        const data = await res.json();
        return Array.isArray(data) ? data : [];
      }catch(e){
        return [];
      }
    }

    function renderStdProtocolSelect(){
      els.stdProtocolSelect.innerHTML = '';

      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = '‚Äî SelecteazƒÉ protocol standard ‚Äî';
      els.stdProtocolSelect.appendChild(opt0);

      stdProtocolsCache.forEach((p, idx) => {
        const opt = document.createElement('option');
        opt.value = String(idx);
        opt.textContent = p?.name || p?.id || `Protocol ${idx+1}`;
        els.stdProtocolSelect.appendChild(opt);
      });
    }

    async function refreshStdProtocols(){
      stdProtocolsCache = await loadStdProtocols();
      renderStdProtocolSelect();
    }

    function protocolRowsToText(rows){
      if (!Array.isArray(rows)) return '';
      return rows
        .map(r => {
          const name = (r?.name ?? '').toString().trim();
          const dose = (r?.dose ?? '').toString().trim();
          const whenHow = (r?.whenHow ?? '').toString().trim();
          const link = (r?.link ?? '').toString().trim();
          const notes = (r?.notes ?? '').toString().trim();
          return [name, dose, whenHow, link, notes].join(' | ');
        })
        .filter(line => line.replace(/\|/g,'').trim().length > 0)
        .join('\n');
    }

    function appendTextToTextarea(text){
      const add = (text || '').trim();
      if (!add) return;

      const current = (els.suppInput.value || '').trimEnd();
      els.suppInput.value = current ? (current + '\n' + add) : add;

      onAnyInput();
    }

    // ===== Local additions catalog =====
    function loadLocalCatalog(){
      try{
        const raw = localStorage.getItem(STORAGE_LOCAL_CATALOG);
        if (!raw) return [];
        const data = JSON.parse(raw);
        return Array.isArray(data) ? data : [];
      }catch(e){
        return [];
      }
    }

    function saveLocalCatalog(list){
      localStorage.setItem(STORAGE_LOCAL_CATALOG, JSON.stringify(list));
    }

    // de-dup simplu (same name+dose+whenHow+link+notes)
    function dedupCatalog(list){
      const seen = new Set();
      const out = [];
      for (const it of list){
        const key = `${it?.name||''}||${it?.dose||''}||${it?.whenHow||''}||${it?.link||''}||${it?.notes||''}`.toLowerCase();
        if (seen.has(key)) continue;
        seen.add(key);
        out.push({
          name: it?.name || '',
          dose: it?.dose || '',
          whenHow: it?.whenHow || '',
          link: it?.link || '',
          notes: it?.notes || ''
        });
      }
      return out;
    }

    async function refreshCatalog(){
      remoteCatalogCache = await loadRemoteCatalog();
      const local = loadLocalCatalog();

      mergedCatalogCache = dedupCatalog([...(remoteCatalogCache || []), ...(local || [])]);
      renderCatalog();
    }

    // ===== Main rows (textarea) =====
    function parseLines(text){
      const lines = (text || '').split(/\r?\n/);
      const rows = [];

      for (const raw of lines){
        const line = raw.trim();
        if (!line) continue;
        if (line.startsWith('#')) continue;

        const parts = line.split('|').map(p => p.trim());
        while (parts.length < 5) parts.push('');

        const [name, dose, whenHow, link, notes] = parts;

        rows.push({ name, dose, whenHow, link, notes });
      }
      return rows;
    }

    function rowsToText(rows){
      return rows
        .map(r => [r.name, r.dose, r.whenHow, r.link, r.notes].map(x => (x ?? '').toString().trim()).join(' | '))
        .join('\n');
    }

    function addRowFromCatalog(it){
      const rows = parseLines(els.suppInput.value);
      rows.push({
        name: it.name || '',
        dose: it.dose || '',
        whenHow: it.whenHow || '',
        link: it.link || '',
        notes: it.notes || ''
      });
      els.suppInput.value = rowsToText(rows);
      onAnyInput();
    }

    function renderTable(){
      const rows = parseLines(els.suppInput.value);
      els.tbody.innerHTML = '';

      for (const r of rows){
        const tr = document.createElement('tr');

        const td1 = document.createElement('td'); td1.textContent = r.name || ''; tr.appendChild(td1);
        const td2 = document.createElement('td'); td2.textContent = r.dose || ''; tr.appendChild(td2);
        const td3 = document.createElement('td'); td3.textContent = r.whenHow || ''; tr.appendChild(td3);

        const td4 = document.createElement('td');
        if (r.link){
          const a = document.createElement('a');
          a.href = r.link;
          a.textContent = r.link;
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
          a.style.color = 'rgba(234,241,255,.82)';
          a.style.textDecoration = 'underline';
          a.style.wordBreak = 'break-all';
          td4.appendChild(a);
        } else {
          td4.textContent = '';
        }
        tr.appendChild(td4);

        const td5 = document.createElement('td'); td5.textContent = r.notes || ''; tr.appendChild(td5);

        els.tbody.appendChild(tr);
      }

      els.rowCount.textContent = String(rows.length);
    }

    function renderHeader(){
      const name = safeTrim(els.clientName.value) || 'Client';
      const goal = safeTrim(els.goal.value) || '‚Äî';
      els.clientNameOut.textContent = name;
      els.printName.textContent = name;
      els.goalOut.textContent = goal;
    }

    function saveState(){
      const payload = {
        clientName: els.clientName.value || '',
        goal: els.goal.value || '',
        suppInput: els.suppInput.value || ''
      };
      localStorage.setItem(STORAGE_STATE, JSON.stringify(payload));
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_STATE);
        if (!raw) return;
        const data = JSON.parse(raw);
        if (!data || typeof data !== 'object') return;

        els.clientName.value = data.clientName || '';
        els.goal.value = data.goal || '';
        els.suppInput.value = data.suppInput || '';
      }catch(e){}
    }

    // ===== Local Protocols =====
    function loadProtocols(){
      try{
        const raw = localStorage.getItem(STORAGE_PROTOCOLS);
        if (!raw) return [];
        const data = JSON.parse(raw);
        return Array.isArray(data) ? data : [];
      }catch(e){ return []; }
    }

    function saveProtocols(list){
      localStorage.setItem(STORAGE_PROTOCOLS, JSON.stringify(list));
    }

    function renderProtocolSelect(){
      const list = loadProtocols();
      els.protocolSelect.innerHTML = '';

      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = '‚Äî SelecteazƒÉ protocol ‚Äî';
      els.protocolSelect.appendChild(opt0);

      for (const p of list){
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.name || 'Protocol';
        els.protocolSelect.appendChild(opt);
      }
    }

    // ===== Backup (export/import) =====
    function buildBackup(){
      return {
        version: 1,
        updatedAt: new Date().toISOString(),
        state: {
          clientName: els.clientName.value || '',
          goal: els.goal.value || '',
          suppInput: els.suppInput.value || ''
        },
        protocols: loadProtocols(),
        localCatalog: loadLocalCatalog()
      };
    }

    function restoreBackup(obj){
      if (!obj || typeof obj !== 'object') throw new Error('Backup invalid');

      const st = obj.state || {};
      els.clientName.value = st.clientName || '';
      els.goal.value = st.goal || '';
      els.suppInput.value = st.suppInput || '';

      if (Array.isArray(obj.protocols)) saveProtocols(obj.protocols);
      if (Array.isArray(obj.localCatalog)) saveLocalCatalog(obj.localCatalog);

      renderProtocolSelect();
      refreshCatalog();
      onAnyInput();
    }

    function downloadJson(filename, obj){
      const text = JSON.stringify(obj, null, 2);
      const blob = new Blob([text], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function renderCatalog(){
      const q = safeTrim(els.catalogSearch.value).toLowerCase();
      const list = mergedCatalogCache || [];

      const filtered = !q
        ? list
        : list.filter(it => {
            const blob = `${it.name} ${it.dose} ${it.whenHow} ${it.link} ${it.notes}`.toLowerCase();
            return blob.includes(q);
          });

      els.catalogList.innerHTML = '';

      for (const it of filtered){
        const box = document.createElement('div');
        box.className = 'item';

        const name = document.createElement('div');
        name.className = 'name';
        name.textContent = it.name || '‚Äî';

        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.innerHTML =
          `<div><b>DozƒÉ:</b> ${it.dose || '‚Äî'}</div>
           <div><b>C√¢nd/Cum:</b> ${it.whenHow || '‚Äî'}</div>
           <div><b>Link:</b> ${(it.link || '‚Äî')}</div>
           <div><b>Note:</b> ${(it.notes || '‚Äî')}</div>`;

        const actions = document.createElement('div');
        actions.className = 'actions';

        const addBtn = document.createElement('button');
        addBtn.className = 'btn';
        addBtn.type = 'button';
        addBtn.textContent = 'AdaugƒÉ';
        addBtn.addEventListener('click', () => addRowFromCatalog(it));

        actions.appendChild(addBtn);

        box.appendChild(name);
        box.appendChild(meta);
        box.appendChild(actions);

        els.catalogList.appendChild(box);
      }
    }

    function onAnyInput(){
      renderHeader();
      renderTable();
      saveState();
    }

    async function init(){
      loadState();
      onAnyInput();

      renderProtocolSelect();

      await refreshCatalog();
      await refreshStdProtocols();

      // inputs
      els.clientName.addEventListener('input', onAnyInput);
      els.goal.addEventListener('input', onAnyInput);
      els.suppInput.addEventListener('input', onAnyInput);

      // std protocols
      els.reloadStdProtocols.addEventListener('click', refreshStdProtocols);
      els.addStdProtocol.addEventListener('click', () => {
        const v = els.stdProtocolSelect.value;
        if (!v) return;

        const idx = Number(v);
        const p = stdProtocolsCache[idx];
        if (!p) return;

        const text = protocolRowsToText(p.rows);
        appendTextToTextarea(text);
      });

      // catalog
      els.catalogSearch.addEventListener('input', renderCatalog);
      els.reloadCatalog.addEventListener('click', refreshCatalog);

      els.resetLocalCatalog.addEventListener('click', () => {
        saveLocalCatalog([]);
        refreshCatalog();
      });

      els.addToLocalCatalog.addEventListener('click', () => {
        const item = {
          name: safeTrim(els.newName.value),
          dose: safeTrim(els.newDose.value),
          whenHow: safeTrim(els.newWhenHow.value),
          link: safeTrim(els.newLink.value),
          notes: safeTrim(els.newNotes.value)
        };
        if (!item.name) return;

        const local = loadLocalCatalog();
        local.unshift(item);
        saveLocalCatalog(local);

        els.newName.value = '';
        els.newDose.value = '';
        els.newWhenHow.value = '';
        els.newLink.value = '';
        els.newNotes.value = '';

        refreshCatalog();
      });

      // local protocols
      els.saveProtocol.addEventListener('click', () => {
        const name = safeTrim(els.protocolName.value) || `Protocol ${new Date().toLocaleDateString()}`;
        const list = loadProtocols();
        const id = (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2));

        list.unshift({
          id,
          name,
          clientName: els.clientName.value || '',
          goal: els.goal.value || '',
          suppInput: els.suppInput.value || ''
        });

        saveProtocols(list);
        renderProtocolSelect();
        els.protocolSelect.value = id;
        els.protocolName.value = '';
      });

      els.loadProtocol.addEventListener('click', () => {
        const id = els.protocolSelect.value;
        if (!id) return;
        const list = loadProtocols();
        const p = list.find(x => x.id === id);
        if (!p) return;

        els.clientName.value = p.clientName || '';
        els.goal.value = p.goal || '';
        els.suppInput.value = p.suppInput || '';
        onAnyInput();
      });

      els.deleteProtocol.addEventListener('click', () => {
        const id = els.protocolSelect.value;
        if (!id) return;
        const list = loadProtocols().filter(x => x.id !== id);
        saveProtocols(list);
        renderProtocolSelect();
        els.protocolSelect.value = '';
      });

      // backup export/import
      els.exportAll.addEventListener('click', () => {
        downloadJson('backup.json', buildBackup());
      });

      els.importAllBtn.addEventListener('click', () => {
        els.importFile.value = '';
        els.importFile.click();
      });

      els.importFile.addEventListener('change', async () => {
        const file = els.importFile.files?.[0];
        if (!file) return;
        const text = await file.text();
        const obj = JSON.parse(text);
        restoreBackup(obj);
      });

      // clear
      els.clearAll.addEventListener('click', () => {
        els.clientName.value = '';
        els.goal.value = '';
        els.suppInput.value = '';
        onAnyInput();
      });
    }

    init();
  </script>
</body>
</html>

