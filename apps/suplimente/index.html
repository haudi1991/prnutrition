<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Protocol suplimente</title>

  <style>
    :root{
      --bg:#0b0f17;
      --muted:#9fb0c3;
      --text:#eaf1ff;
      --accent:#7dd3fc;
      --line:rgba(255,255,255,.10);
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius: 18px;
      --panel: rgba(255,255,255,.03);
    }
    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(125,211,252,.15), transparent 60%),
        radial-gradient(900px 700px at 80% 20%, rgba(167,243,208,.12), transparent 55%),
        var(--bg);
      color:var(--text);
      line-height:1.55;
      padding: 22px 14px;
    }
    .wrap{ max-width: 980px; margin: 0 auto; }

    header{
      display:flex; flex-direction:column; gap:10px;
      margin-bottom:14px;
    }
    .badge{
      display:inline-flex; align-items:center;
      font-size: 12px; color: var(--muted);
      padding: 7px 10px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background: rgba(255,255,255,.03);
      width: fit-content;
    }
    h1{
      font-size: clamp(24px, 2.8vw, 34px);
      margin:0;
      letter-spacing: -0.02em;
    }
    .sub{
      margin:0;
      color: var(--muted);
      max-width: 90ch;
      font-size: 13px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .section{ padding: 16px; }

    .panel{
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      background: var(--panel);
      padding: 14px;
    }

    /* ===== Print-only title ===== */
    .print-title{
      display:none;
      font-weight: 900;
      letter-spacing: -0.01em;
      margin: 0 0 10px 0;
    }
    .print-title .muted{ color: rgba(234,241,255,.80); }

    /* ===== Editor UI ===== */
    .editor{ display:grid; gap: 10px; }

    .grid2{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media (min-width: 820px){
      .grid2{ grid-template-columns: 1fr 1fr; }
    }

    .field{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .field label{
      display:block;
      font-size: 12px;
      color: rgba(234,241,255,.70);
      margin-bottom: 6px;
    }
    .field input, .field select{
      width:100%;
      font: inherit;
      color: var(--text);
      background: rgba(255,255,255,.02);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 12px;
      padding: 10px 10px;
      outline: none;
    }

    .btnrow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-top: 8px;
    }
    .btn{
      cursor:pointer;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding: 9px 12px;
      border-radius: 12px;
      font: inherit;
      font-size: 13px;
      white-space: nowrap;
    }
    .btn:hover{ background: rgba(255,255,255,.06); }

    .hint{
      font-size: 12px;
      color: rgba(234,241,255,.62);
      line-height: 1.4;
    }

    .callout{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(125,211,252,.06);
      color: rgba(234,241,255,.80);
      font-size: 13px;
      line-height: 1.4;
    }

    /* ===== Catalog ===== */
    .catalog-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top: 8px;
    }
    @media (min-width: 820px){
      .catalog-grid{ grid-template-columns: 1fr 1fr; }
    }
    .item{
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      background: rgba(255,255,255,.02);
      padding: 10px 12px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .item .name{
      font-weight: 850;
      color: rgba(234,241,255,.92);
      letter-spacing: -0.01em;
    }
    .item .meta{
      font-size: 12px;
      color: rgba(234,241,255,.70);
      line-height: 1.35;
      word-break: break-word;
    }
    .item .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top: 6px;
    }

    /* ===== Table ===== */
    .table-wrap{
      margin-top: 12px;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      overflow:hidden;
      background: rgba(255,255,255,.02);
    }
    table{
      width:100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    thead th{
      text-align:left;
      font-weight: 850;
      color: rgba(234,241,255,.90);
      background: rgba(255,255,255,.04);
      border-bottom: 1px solid rgba(255,255,255,.10);
      padding: 10px 10px;
      vertical-align: top;
    }
    tbody td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      color: rgba(234,241,255,.78);
      vertical-align: top;
      word-break: break-word;
    }
    tbody tr:last-child td{ border-bottom: none; }

    /* editable cells */
    td[contenteditable="true"]{
      outline: none;
      border-radius: 8px;
    }
    td[contenteditable="true"]:focus{
      box-shadow: 0 0 0 2px rgba(125,211,252,.18);
      background: rgba(255,255,255,.02);
    }

    .removeBtn{
      cursor:pointer;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: rgba(234,241,255,.85);
      border-radius: 10px;
      padding: 6px 10px;
      font: inherit;
      font-size: 12px;
    }
    .removeBtn:hover{ background: rgba(255,255,255,.06); }

    .no-print { display: block; }

    /* =========================
       PRINT (PDF)
       ========================= */
    @media print {
      *{
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      @page{
        size: A4 landscape;
        margin: 6mm;
      }
      html, body{
        background: var(--bg) !important;
        color: var(--text) !important;
        margin: 0 !important;
        padding: 0 !important;
      }

      header{ display:none !important; }
      .editor, .no-print { display:none !important; }

      .section{ padding: 12px !important; }
      .panel{ padding: 10px !important; }

      .print-title{
        display:block !important;
        font-size: 20px !important;
      }

      table{ font-size: 12px !important; }
      thead th, tbody td{ padding: 8px 8px !important; }

      .table-wrap, .panel, .callout{
        break-inside: avoid !important;
        page-break-inside: avoid !important;
      }

      a[href]::after{ content: "" !important; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="badge">üíä Protocol suplimente</div>
      <h1>Protocol suplimente ‚Äì <span id="clientNameOut">Client</span></h1>
      <p class="sub">Selectezi un protocol (din <code>/data/protocols.json</code>) sau adaugi din catalog (din <code>/data/catalog.json</code>). FƒÉrƒÉ salvare localƒÉ.</p>
    </header>

    <main class="card">
      <section class="section">
        <div class="panel">

          <!-- Titlu pentru PDF (print only) -->
          <div class="print-title">
            Protocol suplimente ‚Äì <span id="printName" class="muted">Client</span>
          </div>

          <!-- ===== EDITOR (no localStorage) ===== -->
          <div class="editor">

            <div class="grid2">
              <div class="field">
                <label>Nume client</label>
                <input id="clientName" placeholder="Ex: Andrei Popescu" />
              </div>
              <div class="field">
                <label>Obiectiv / context (1‚Äì2 fraze)</label>
                <input id="goal" placeholder="Ex: somn, energie, stres, recuperare..." />
              </div>
            </div>

            <!-- Protocoale standard (GitHub) -->
            <div class="field">
              <label>Protocoale (GitHub)</label>
              <div class="grid2">
                <div>
                  <select id="stdProtocolSelect"></select>
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <button class="btn" id="reloadData" type="button">Re√ÆncarcƒÉ catalog + protocoale</button>
                  <button class="btn" id="addStdProtocol" type="button">AdaugƒÉ protocol</button>
                </div>
              </div>
              <div class="hint" style="margin-top:8px;">
                Protocolul adaugƒÉ √Æn tabel item-urile definite doar ca ‚Äúreferin»õe‚Äù (ID) cƒÉtre <code>catalog.json</code>.
              </div>
            </div>

            <!-- Catalog standard -->
            <div class="field">
              <label>Catalog suplimente (GitHub)</label>
              <div class="grid2">
                <div><input id="catalogSearch" placeholder="CautƒÉ (ex: vitamina d, omega, magneziu)" /></div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <button class="btn" id="addEmptyRow" type="button">AdaugƒÉ r√¢nd gol</button>
                  <button class="btn" id="clearTable" type="button">»òterge tabel</button>
                </div>
              </div>
              <div class="catalog-grid" id="catalogList"></div>
              <div class="hint" style="margin-top:8px;">
                Po»õi edita manual orice celulƒÉ din tabel (inclusiv brand/link/note).
              </div>
            </div>

          </div>

          <div class="callout">
            <b>Obiectiv:</b> <span id="goalOut">‚Äî</span>
          </div>

          <div class="btnrow no-print">
            <div class="hint">R√¢nduri √Æn tabel: <b id="rowCount">0</b></div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn" id="printBtn" type="button" onclick="window.print()">Print / Save PDF</button>
            </div>
          </div>

          <div class="table-wrap" aria-label="Tabel suplimente">
            <table>
              <thead>
                <tr>
                  <th style="width:22%;">Supliment</th>
                  <th style="width:16%;">Brand</th>
                  <th style="width:12%;">DozƒÉ</th>
                  <th style="width:28%;">Note</th>
                  <th style="width:22%;">Link</th>
                  <th class="no-print" style="width:7%;"></th>
                </tr>
              </thead>
              <tbody id="suppTbody"></tbody>
            </table>
          </div>

        </div>
      </section>
    </main>
  </div>

  <script>
    const els = {
      clientName: document.getElementById('clientName'),
      goal: document.getElementById('goal'),
      clientNameOut: document.getElementById('clientNameOut'),
      printName: document.getElementById('printName'),
      goalOut: document.getElementById('goalOut'),

      stdProtocolSelect: document.getElementById('stdProtocolSelect'),
      reloadData: document.getElementById('reloadData'),
      addStdProtocol: document.getElementById('addStdProtocol'),

      catalogSearch: document.getElementById('catalogSearch'),
      catalogList: document.getElementById('catalogList'),

      addEmptyRow: document.getElementById('addEmptyRow'),
      clearTable: document.getElementById('clearTable'),

      tbody: document.getElementById('suppTbody'),
      rowCount: document.getElementById('rowCount'),
    };

    // Data only from GitHub Pages (no localStorage)
    const CATALOG_URL = '../../data/catalog.json';
    const PROTOCOLS_URL = '../../data/protocols.json';

    let catalog = [];
    let catalogById = new Map();
    let protocols = [];
    let rows = []; // in-memory only

    function safeTrim(x){ return (x ?? '').toString().trim(); }
    function slugify(s){
      return safeTrim(s).toLowerCase()
        .replace(/ƒÉ/g,'a').replace(/√¢/g,'a').replace(/√Æ/g,'i').replace(/»ô/g,'s').replace(/≈£/g,'t').replace(/»õ/g,'t')
        .replace(/[^a-z0-9]+/g,'-')
        .replace(/^-+|-+$/g,'');
    }

    async function fetchJson(url){
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`${url} -> ${res.status}`);
      return await res.json();
    }

    function normalizeCatalogItem(it){
      const name = safeTrim(it?.name);
      const id = safeTrim(it?.id) || slugify(name);
      return {
        id,
        name,
        brand: safeTrim(it?.brand),
        dose: safeTrim(it?.dose),
        link: safeTrim(it?.link),
        notes: safeTrim(it?.notes),
      };
    }

    async function loadData(){
      const [catRaw, protRaw] = await Promise.all([
        fetchJson(CATALOG_URL),
        fetchJson(PROTOCOLS_URL),
      ]);

      catalog = Array.isArray(catRaw) ? catRaw.map(normalizeCatalogItem) : [];
      catalogById = new Map(catalog.map(x => [x.id, x]));

      protocols = Array.isArray(protRaw) ? protRaw : [];

      renderProtocolSelect();
      renderCatalog();
    }

    function renderProtocolSelect(){
      els.stdProtocolSelect.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = '‚Äî SelecteazƒÉ protocol ‚Äî';
      els.stdProtocolSelect.appendChild(opt0);

      protocols.forEach((p, idx) => {
        const opt = document.createElement('option');
        opt.value = String(idx);
        opt.textContent = p?.name || p?.id || `Protocol ${idx+1}`;
        els.stdProtocolSelect.appendChild(opt);
      });
    }

    function renderHeader(){
      const name = safeTrim(els.clientName.value) || 'Client';
      const goal = safeTrim(els.goal.value) || '‚Äî';
      els.clientNameOut.textContent = name;
      els.printName.textContent = name;
      els.goalOut.textContent = goal;
    }

    function addRow(r){
      rows.push({
        name: safeTrim(r?.name),
        brand: safeTrim(r?.brand),
        dose: safeTrim(r?.dose),
        notes: safeTrim(r?.notes),
        link: safeTrim(r?.link),
      });
      renderTable();
    }

    function addCatalogItemToTable(item){
      addRow(item);
    }

    function addProtocolToTable(p){
      const ids = Array.isArray(p?.items) ? p.items : [];
      for (const ref of ids){
        const id = safeTrim(ref);
        const it = catalogById.get(id);
        if (it){
          const exists = rows.some(r => slugify(r.name) === slugify(it.name) && safeTrim(r.brand) === safeTrim(it.brand));
          if (!exists) addCatalogItemToTable(it);
        } else {
          addRow({ name: id });
        }
      }
      renderHeader();
    }

    function renderCatalog(){
      const q = safeTrim(els.catalogSearch.value).toLowerCase();
      const filtered = !q ? catalog : catalog.filter(it => {
        const blob = `${it.name} ${it.brand} ${it.dose} ${it.link} ${it.notes}`.toLowerCase();
        return blob.includes(q);
      });

      els.catalogList.innerHTML = '';

      for (const it of filtered){
        const box = document.createElement('div');
        box.className = 'item';

        const name = document.createElement('div');
        name.className = 'name';
        name.textContent = it.name || '‚Äî';

        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.innerHTML =
          `<div><b>Brand:</b> ${it.brand || '‚Äî'}</div>
           <div><b>DozƒÉ:</b> ${it.dose || '‚Äî'}</div>
           <div><b>Link:</b> ${it.link ? it.link : '‚Äî'}</div>
           <div><b>Note:</b> ${it.notes || '‚Äî'}</div>`;

        const actions = document.createElement('div');
        actions.className = 'actions';

        const addBtn = document.createElement('button');
        addBtn.className = 'btn';
        addBtn.type = 'button';
        addBtn.textContent = 'AdaugƒÉ √Æn tabel';
        addBtn.addEventListener('click', () => addCatalogItemToTable(it));

        actions.appendChild(addBtn);

        box.appendChild(name);
        box.appendChild(meta);
        box.appendChild(actions);

        els.catalogList.appendChild(box);
      }
    }

    function renderTable(){
      els.tbody.innerHTML = '';

      rows.forEach((r, idx) => {
        const tr = document.createElement('tr');

        function tdEditable(field){
          const td = document.createElement('td');
          td.contentEditable = 'true';
          td.dataset.field = field;
          td.dataset.idx = String(idx);
          td.textContent = r[field] || '';
          return td;
        }

        tr.appendChild(tdEditable('name'));
        tr.appendChild(tdEditable('brand'));
        tr.appendChild(tdEditable('dose'));
        tr.appendChild(tdEditable('notes'));
        tr.appendChild(tdEditable('link'));

        const tdRemove = document.createElement('td');
        tdRemove.className = 'no-print';
        const btn = document.createElement('button');
        btn.className = 'removeBtn';
        btn.type = 'button';
        btn.textContent = '»òterge';
        btn.addEventListener('click', () => {
          rows.splice(idx, 1);
          renderTable();
        });
        tdRemove.appendChild(btn);
        tr.appendChild(tdRemove);

        els.tbody.appendChild(tr);
      });

      els.rowCount.textContent = String(rows.length);
    }

    // Update rows on edit
    els.tbody.addEventListener('focusout', (e) => {
      const td = e.target;
      if (!(td instanceof HTMLElement)) return;
      if (td.tagName !== 'TD') return;
      const field = td.dataset.field;
      const idx = Number(td.dataset.idx);
      if (!field || Number.isNaN(idx) || !rows[idx]) return;
      rows[idx][field] = safeTrim(td.textContent);
    });

    function resetAll(){
      // default: empty every time you open
      els.clientName.value = '';
      els.goal.value = '';
      els.catalogSearch.value = '';
      els.stdProtocolSelect.value = '';
      rows = [];
      renderHeader();
      renderCatalog();
      renderTable();
    }

    async function init(){
      renderHeader();
      renderTable(); // empty

      els.clientName.addEventListener('input', renderHeader);
      els.goal.addEventListener('input', renderHeader);

      els.catalogSearch.addEventListener('input', renderCatalog);

      els.addEmptyRow.addEventListener('click', () => addRow({}));
      els.clearTable.addEventListener('click', () => { rows = []; renderTable(); });

      els.reloadData.addEventListener('click', async () => {
        await loadData();
      });

      els.addStdProtocol.addEventListener('click', () => {
        const v = els.stdProtocolSelect.value;
        if (!v) return;
        const idx = Number(v);
        const p = protocols[idx];
        if (!p) return;

        if (!safeTrim(els.goal.value) && safeTrim(p.goal)) {
          els.goal.value = p.goal;
        }
        addProtocolToTable(p);
        renderHeader();
      });

      await loadData();
      resetAll();
    }

    init().catch(() => {
      resetAll();
    });
  </script>
</body>
</html>

